name: Pet Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

env:
  VERSION: ${{ github.ref_name }}
  PARENT_POM: pet-parent/pom.xml

jobs:
  # release-branch-name:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     branch-name: ${{ steps.set-branch-name.outputs.branch-name }}
  #   steps:
  #     - id: set-branch-name
  #       run: |
  #         BRANCH_NAME=main
  #         if [[ ${{ !endsWith(env.VERSION, '.0') }} ]]; then
  #           BRANCH_NAME=$(echo ${{ env.VERSION }} | sed -r s/^\([0-9]+\.[0-9]+\.\)[0-9]+$/\\1x/)
  #         fi
  #         echo "::set-output name=branch-name::$BRANCH_NAME"

  validate-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Validate version number
        run: |
          echo Verifying that ${{ env.VERSION }} is the same as parent POM version
          test ${{ env.VERSION }} = $(sed -n -r 's/.+<revision>([0-9]+\.[0-9]+\.[0-9]+)<\/revision>/\1/p' ${{ env.PARENT_POM }})

  last-run-numbers:
    runs-on: ubuntu-latest
    needs:
      - validate-version
    outputs:
      cat-service: ${{ steps.cat-service.outputs.last-run-number }}
    steps:
      - uses: actions/checkout@v2
      - id: base-branch-name
        uses: ./.github/actions/base-branch-name
        with:
          version: ${{ env.VERSION }}
      - id: cat-service
        uses: ./.github/actions/last-workflow-run-number
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          workflow-name: cat-service
          branch-name: ${{ steps.base-branch-name.outputs.branch-name }}
      # - uses: actions/checkout@v2
      # - id: cat-service
      #   name: Get latest cat-service run number
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     .github/scripts/output-last-workflow-run-number.sh cat-service ${{ github.repository }}
          
  release-notes:
    runs-on: ubuntu-latest
    needs: last-run-numbers
    steps:
      - name: Generate release notes
        run: |
          echo "These are the release notes" >> release-notes.txt
          echo "Application build numbers in this release:" >> release-notes.txt
          echo "* cat-service: ${{ env.VERSION }}-gh${{ needs.last-run-numbers.outputs.cat-service }}" >> release-notes.txt
      - name: Upload release notes artifact
        uses: actions/upload-artifact@v3
        with:
          name: release-notes
          path: release-notes.txt

  release:
    runs-on: ubuntu-latest
    needs: release-notes
    steps:
      - uses: actions/checkout@v2
      - name: Download release notes artifact
        uses: actions/download-artifact@v3
        with:
          name: release-notes
      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ env.VERSION }} --notes-file release-notes.txt --title "${{ env.VERSION }}"

  promote:
    runs-on: ubuntu-latest
    needs: last-run-numbers
    steps:
      - name: Promote to ACR
        run: |
          echo "This would be where we would promote the latest builds"
          echo ${{ env.VERSION }}
          echo "Promoting cat-service build ${{ env.VERSION }}-gh${{ needs.last-run-numbers.outputs.cat-service }}"

  maintenance-branch:
    if: endsWith(github.ref_name, '.0') # Only versions on the main branch have no patch version
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - uses: actions/checkout@v2
        with:
          ssh-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
      - id: maintenance-branch-name
        uses: ./.github/actions/maintenance-branch-name
        with:
          version: ${{ env.VERSION }}
      - id: bump-version
        uses: ./.github/actions/bump-maven-revision
        with:
          pom-file: ${{ env.PARENT_POM }}
          version-type: patch
      - uses: ./.github/actions/commit-and-push
        env:
          BRANCH_NAME: ${{ steps.maintenance-branch-name.outputs.branch-name }}
        with:
          branch: ${{ env.BRANCH_NAME }}
          files: ${{ env.PARENT_POM }}
          message: 'Bump minor version in ${{ env.BRANCH_NAME }} to ${{ steps.bump-version.outputs.new-version }}'
      # - name: Create maintenance branch
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     BRANCH_NAME=$(echo ${{ env.VERSION }} | sed -r s/^\([0-9]+\.[0-9]+\.\)[0-9]+$/\\1x/)
      #     echo Creating maintenance branch $BRANCH_NAME from tag ${{ env.VERSION }}
      #     git config user.name "GitHub Release Workflow"
      #     git config user.email "<>"
      #     .github/scripts/bump-maven-revision.sh ${{ env.VERSION }} patch ${{ env.PARENT_POM }} $BRANCH_NAME

  main-branch-minor-version-bump:
    if: endsWith(github.ref_name, '.0')
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - uses: actions/checkout@v2
        with:
          ssh-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
      - id: bump-version
        uses: ./.github/actions/bump-maven-revision
        with:
          pom-file: ${{ env.PARENT_POM }}
          version-type: minor
      - uses: ./.github/actions/commit-and-push
        # env:
        #   GITHUB_TOKEN: ${{ secrets.ACTIONS_DEPLOY_KEY_NO_HEADER }}
        with:
          branch: feature/bump-main-branch-minor-version
          files: $PARENT_POM
          message: 'Bump minor version in main to ${{ steps.bump-version.outputs.new-version }}'
          # pull-request-base-branch: main
      - id: create-pull-request
        uses: peterevans/create-pull-request@v3.10.1
        with:
          base: main
          branch: feature/bump-main-branch-minor-version
          delete-branch: true
          title: 'Bump minor version in main to ${{ steps.bump-version.outputs.new-version }}'
          body: 'Bump minor version in main to ${{ steps.bump-version.outputs.new-version }}'
      - uses: peterevans/enable-pull-request-automerge@v1.1.0
        if: steps.create-pull-request.outputs.pull-request-operation == 'created'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create-pull-request.outputs.pull-request-number }}
          merge-method: rebase
      - uses: juliangruber/approve-pull-requests-action@v1.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.create-pull-request.outputs.pull-request-number }}

  # main-branch-minor-version-bump:
  #   if: endsWith(github.ref_name, '.0') # Main branch releases result in a minor version number bump
  #   runs-on: ubuntu-latest
  #   needs: validate-version
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: Bump minor version
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         BRANCH_NAME=feature/bump-main-branch-minor-version
  #         git config user.name "GitHub Release Workflow"
  #         git config user.email "<>"
  #         .github/scripts/bump-maven-revision.sh ${{ env.VERSION }} minor ${{ env.PARENT_POM }} $BRANCH_NAME
  #         echo "Creating PR" 
  #         gh pr create --base main --title "Bump version in main branch" --body "Version bump"
  #         gh pr merge $PR_URL --admin --rebase
  #         git push -d origin $BRANCH_NAME

  maintenance-branch-patch-version-bump:
    if: ${{ !endsWith(github.ref_name, '.0') }}
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - uses: actions/checkout@v2
        with:
          ssh-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
      - id: maintenance-branch-name
        uses: ./.github/actions/maintenance-branch-name
        with:
          version: ${{ env.VERSION }}
      - id: bump-version
        uses: ./.github/actions/bump-maven-revision
        with:
          pom-file: ${{ env.PARENT_POM }}
          version-type: patch
      - uses: ./.github/actions/commit-and-push
        env:
          BRANCH_NAME: ${{ steps.maintenance-branch-name.outputs.branch-name }}
        with:
          branch: ${{ env.BRANCH_NAME }}
          files: ${{ env.PARENT_POM }}
          message: 'Bump minor version in ${{ env.BRANCH_NAME }} to ${{ steps.bump-version.outputs.new-version }}'

  # maintenance-branch-patch-version-bump:
  #   if: ${{ !endsWith(github.ref_name, '.0') }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: Bump patch version
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         BRANCH_NAME=$(echo ${{ env.VERSION }} | sed -r s/^\([0-9]+\.[0-9]+\.\)[0-9]+$/\\1x/)
  #         git config user.name "GitHub Release Workflow"
  #         git config user.email "<>"
  #         .github/scripts/bump-maven-revision.sh ${{ env.VERSION }} patch ${{ env.PARENT_POM }} $BRANCH_NAME